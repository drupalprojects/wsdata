<?php

/**
 * @file
 * Main module for wsconfig
 */

/**
 * Implememnts hook_wsconfig_processor_info().
 */
function wsdata_wsconfig_processor_info() {
  return array(
    'wsdata_simple_xml_processor' => array(
      'fields' => array(
        'list_boolean' => t('WSData Simple XML Processor'),
        'number_decimal' => t('WSData Simple XML Processor'),
        'number_float' => t('WSData Simple XML Processor'),
        'number_integer' => t('WSData Simple XML Processor'),
        'list_float' => t('WSData Simple XML Processor'),
        'list_integer' => t('WSData Simple XML Processor'),
        'list_text' => t('WSData Simple XML Processor'),
        'text_long' => t('WSData Simple XML Processor'),
        'text_with_summary' => t('WSData Simple XML Processor'),
        'text' => t('WSData Simple XML Processor'),
      ),
      'data' => t('WSData Simple XML Processor'),
    ),
    'wsdata_simple_json_processor' => array(
      'fields' => array(
        'list_boolean' => t('WSData Simple JSON Processor'),
        'number_decimal' => t('WSData Simple JSON Processor'),
        'number_float' => t('WSData Simple JSON Processor'),
        'number_integer' => t('WSData Simple JSON Processor'),
        'list_float' => t('WSData Simple JSON Processor'),
        'list_integer' => t('WSData Simple JSON Processor'),
        'list_text' => t('WSData Simple JSON Processor'),
        'text_long' => t('WSData Simple JSON Processor'),
        'text_with_summary' => t('WSData Simple JSON Processor'),
        'text' => t('WSData Simple JSON Processor'),
      ),
      'data' => t('WSData Simple JSON Processor'),
    ),
  );
}

/**
 * Class definition for Web Service data parser
 */
abstract class WsData {
  // Storage for parsed data
  public $data;

  // Storage for error information
  protected $error;

  public function __construct($data = NULL, &$entity = NULL) {
    $this->entity = $entity;
    if (isset($data) and $data) {
      $this->addData($data);
    }
  }

  // Return any error messages or error data
  public function getError() {
    return $error;
  }

  /**
   * Retrieve the value for the given data key.
   *
   * This function retrieves data from the structured array in $this->data
   *  using $key as a key.  $key should be a string, with the character ':'
   *  delimiting the parts of the key.
   *  I.E.  The key  something:someplace with retrive $this->data['something']['someplace']
   *  N.B.  This function can be overridden to work with whatever the ->parse function
   *  is implemented to return.
   */
  public function getData($key = '') {
    if (is_array($this->data)) {
      if (empty($key)) {
        return $this->data;
      }
      $return = $this->data;
      $location = explode(":", $key);
      foreach ($location as $l) {
        if (isset($return[$l])) {
          $return = $return[$l];
        }
        else {
          return FALSE;
        }
      }
      return $return;
    }
    return FALSE;
  }

  /**
   * Add data to an empty object or replace all existing data
   */
  public function addData($data) {
    $this->data = $this->parse($data);
  }

  // Returns an array of the content type of the data this processor accepts
  abstract public function accepts();

  // Parse the web service response string into a structured array and return the array
  abstract protected function parse($data);
}

/**
 * Class definition for Web Service Connector
 */
abstract class WsConnector {
  protected $expires;
  protected $cacheDefaultTime;
  protected $cacheDefaultOverride;
  protected $endpoint;

  public function getEndpoint() {
    return $this->endpoint;
  }

  public function __construct($endpoint) {
    $this->endpoint = $endpoint;
    $this->expires = 0;
    $this->cacheDefaultTime = 0;
    $this->cacheDefaultOverride = FALSE;
  }

  public function supportsCaching() {
    return FALSE;
  }

  public function defaultCache($mintime = 0, $override = FALSE) {
    $this->cacheDefaultTime = $mintime;
    $this->cacheDefaultOverride = $override;
  }

  abstract function getMethods();

  abstract public function wscall($type, $method, $argument, $options);

  public function create($method, $object, $options = array()) {
    $this->expires = 0;
    return $this->wscall('create', $method, $object, $options);
  }

  public function read($method, $id, $options = array()) {
    $this->expires = 0;
    return $this->wscall('read', $method, $id, $options);
  }

  public function update($id, $method, $object, $options = array()) {
    $this->expires = 0;
    return $this->wscall('update', $method, array( $id, $object), $options);
  }

  public function delete($id, $method, $options = array()) {
    $this->expires = 0;
    return $this->wscall('delete', $method, $id, $options);
  }

  public function index($method, $options = array()) {
    $this->expires = 0;
    return $this->wscall('index', $method, array(), $options);
  }

  public function expires() {
    if ($this->expires > 0) {
      return $this->expires;
    }
    else {
      return FALSE;
    }
  }
}
